<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNCP Explorer | Dashboard de Contratações</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark .glass-effect { background: rgba(15, 23, 42, 0.8); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; }
        .dark mark { background-color: #854d0e; color: #fef08a; }
        tr.details-row { display: none; }
        tr.details-row.show { display: table-row; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-full transition-colors duration-300">
    
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 w-full border-b border-slate-200 dark:border-slate-800 glass-effect">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="bg-primary-600 p-2 rounded-lg">
                        <i class="fas fa-database text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight">PNCP <span class="text-primary-600">Explorer</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Stats Grid -->
            <div id="stats-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="animate-pulse bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 h-24"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 h-24"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 h-24"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 h-24"></div>
            </div>

            <!-- Filters & Search -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-4 mb-6 shadow-sm">
                <div class="flex flex-col gap-4">
                    <!-- Search Row -->
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="Buscar por descrição, vencedor, processo..." 
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all">
                        </div>
                        <button id="search-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                    </div>
                    
                    <!-- Filters Row -->
                    <div class="flex flex-wrap gap-3">
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Ano</label>
                            <select id="year-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todos os Anos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Modalidade</label>
                            <select id="modalidade-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todas as Modalidades</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Status</label>
                            <select id="status-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todos os Status</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-950 border-b border-slate-200 dark:border-slate-800">
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500 w-10"></th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Publicação</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Ano</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Compra</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Descrição</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Status</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-primary-600"></div>
                                    <p class="mt-2 text-slate-500">Carregando dados...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination-container" class="px-6 py-4 bg-slate-50 dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <p id="pagination-info" class="text-sm text-slate-500"></p>
                    <div id="pagination-buttons" class="flex items-center gap-1"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="py-6 border-t border-slate-200 dark:border-slate-800 text-center text-sm text-slate-500">
            <p>PNCP Explorer &copy; 2026 - Dados atualizados via GitHub Actions</p>
        </footer>
    </div>

    <script>
        const DATA_URL = './dados.json';
        const PER_PAGE = 15;
        
        let allData = [], stats = {}, search = '', statusFilter = 'all', yearFilter = 'all', modalidadeFilter = 'all', page = 1;

        // --- Utils ---
        const normalize = (t) => t ? t.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';
        
        const highlight = (text, term) => {
            if (!term || !text) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.toString().replace(regex, `<mark>$1</mark>`);
        };

        const getBadgeClass = (status) => {
            const map = {
                'Homologado': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400',
                'Fracassado': 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400',
                'Em andamento': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                'Divulgada': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
            };
            return map[status] || 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-400';
        };

        // --- Theme ---
        const initTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });

        // --- Data ---
        async function loadData() {
            try {
                const res = await fetch(`${DATA_URL}?v=${Date.now()}`);
                const json = await res.json();
                allData = json.data || [];
                stats = json.stats || calculateStats(allData);
                populateFilters();
                render();
            } catch (e) {
                console.error(e);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-rose-500">Erro ao carregar dados.</td></tr>`;
            }
        }

        function calculateStats(data) {
            return {
                totalItens: data.length,
                valorTotalEstimado: data.reduce((acc, i) => acc + (i.valorTotalEstimado || 0), 0),
                itensHomologados: data.filter(i => i.situacaoItem === 'Homologado').length,
                itensFracassados: data.filter(i => i.situacaoItem === 'Fracassado').length
            };
        }

        function populateFilters() {
            const years = [...new Set(allData.map(i => i.ano))].filter(Boolean).sort((a,b) => b-a);
            const statuses = [...new Set(allData.map(i => i.situacaoItem))].filter(Boolean).sort();
            const modalidades = [...new Set(allData.map(i => i.modalidade))].filter(Boolean).sort();
            
            const ySelect = document.getElementById('year-select');
            years.forEach(y => ySelect.innerHTML += `<option value="${y}">${y}</option>`);
            
            const sSelect = document.getElementById('status-select');
            statuses.forEach(s => sSelect.innerHTML += `<option value="${s}">${s}</option>`);

            const mSelect = document.getElementById('modalidade-select');
            modalidades.forEach(m => mSelect.innerHTML += `<option value="${m}">${m}</option>`);
        }

        // --- Rendering ---
        function render() {
            const filtered = getFiltered();
            const paginated = filtered.slice((page - 1) * PER_PAGE, page * PER_PAGE);
            
            renderStats();
            renderTable(paginated);
            renderPagination(filtered.length);
        }

        function renderStats() {
            const container = document.getElementById('stats-container');
            const items = [
                { label: 'Total de Itens', val: stats.totalItens?.toLocaleString('pt-BR'), icon: 'fa-list', color: 'text-blue-600' },
                { label: 'Valor Estimado', val: 'R$ ' + (stats.valorTotalEstimado?.toLocaleString('pt-BR', {minimumFractionDigits:2})), icon: 'fa-hand-holding-dollar', color: 'text-emerald-600' },
                { label: 'Homologados', val: stats.itensHomologados?.toLocaleString('pt-BR'), icon: 'fa-check-circle', color: 'text-emerald-500' },
                { label: 'Fracassados', val: stats.itensFracassados?.toLocaleString('pt-BR'), icon: 'fa-times-circle', color: 'text-rose-500' }
            ];
            
            container.innerHTML = items.map(i => `
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-500">${i.label}</span>
                        <i class="fas ${i.icon} ${i.color}"></i>
                    </div>
                    <div class="text-2xl font-bold">${i.val || 0}</div>
                </div>
            `).join('');
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">Nenhum resultado encontrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map((item, idx) => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer group" onclick="toggleRow(${idx})">
                    <td class="px-6 py-4">
                        <i id="icon-${idx}" class="fas fa-chevron-right text-slate-300 group-hover:text-primary-500 transition-transform"></i>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                        ${item.dataPublicacao ? new Date(item.dataPublicacao).toLocaleDateString('pt-BR') : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-500">
                        ${item.ano || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-primary-600 dark:text-primary-400">
                        ${highlight(item.compra, search)}
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                        ${highlight(item.descricao, search)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeClass(item.situacaoItem)}">
                            ${item.situacaoItem || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <a href="${item.linkPNCP}" target="_blank" onclick="event.stopPropagation()" class="text-slate-400 hover:text-primary-600 transition-colors">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </td>
                </tr>
                <tr id="details-${idx}" class="details-row bg-slate-50/50 dark:bg-slate-800/20">
                    <td colspan="7" class="px-6 py-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-1">Objeto Completo</h4>
                                    <p class="text-sm leading-relaxed">${highlight(item.objeto, search)}</p>
                                </div>
                                <div class="flex gap-8">
                                    <div>
                                        <h4 class="text-xs font-semibold text-slate-400 uppercase mb-1">Processo</h4>
                                        <p class="text-sm font-medium">${item.processo || '-'}</p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-semibold text-slate-400 uppercase mb-1">Modalidade</h4>
                                        <p class="text-sm font-medium">${item.modalidade || '-'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-white dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-800">
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">Resultado da Contratação</h4>
                                    <div class="flex flex-col gap-2">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Vencedor:</span>
                                            <span class="font-semibold text-right">${highlight(item.vencedor, search)}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Valor Homologado:</span>
                                            <span class="font-bold text-emerald-600">R$ ${item.valorTotalHomologado?.toLocaleString('pt-BR', {minimumFractionDigits:2}) || '0,00'}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Quantidade:</span>
                                            <span>${item.qtdHomologada || 0} ${item.unidade || ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 flex items-center gap-2">
                                    <i class="fas fa-info-circle"></i>
                                    Publicado em: ${item.dataPublicacao}
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(total) {
            const totalPages = Math.ceil(total / PER_PAGE);
            const info = document.getElementById('pagination-info');
            const btns = document.getElementById('pagination-buttons');
            
            info.textContent = `Mostrando ${(page-1)*PER_PAGE+1} a ${Math.min(page*PER_PAGE, total)} de ${total} registros`;
            
            let html = '';
            const addBtn = (p, label, active=false, disabled=false) => {
                html += `<button onclick="goToPage(${p})" ${disabled ? 'disabled' : ''} 
                    class="px-3 py-1.5 rounded-md text-sm font-medium transition-all ${active ? 'bg-primary-600 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 disabled:opacity-30'}">
                    ${label}
                </button>`;
            };

            addBtn(1, '<i class="fas fa-angle-double-left"></i>', false, page === 1);
            addBtn(page - 1, '<i class="fas fa-angle-left"></i>', false, page === 1);
            
            for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                addBtn(i, i, i === page);
            }

            addBtn(page + 1, '<i class="fas fa-angle-right"></i>', false, page === totalPages);
            addBtn(totalPages, '<i class="fas fa-angle-double-right"></i>', false, page === totalPages);
            
            btns.innerHTML = html;
        }

        // --- Logic ---
        function getFiltered() {
            const term = normalize(search);
            return allData.filter(i => {
                const mSearch = !term || [i.descricao, i.vencedor, i.compra, i.objeto, i.processo].some(v => normalize(v).includes(term));
                const mStatus = statusFilter === 'all' || i.situacaoItem === statusFilter;
                const mYear = yearFilter === 'all' || i.ano == yearFilter;
                const mModalidade = modalidadeFilter === 'all' || i.modalidade === modalidadeFilter;
                return mSearch && mStatus && mYear && mModalidade;
            });
        }

        function executeSearch() {
            search = document.getElementById('search-input').value;
            page = 1;
            render();
        }

        function goToPage(p) {
            page = p;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleRow(idx) {
            const row = document.getElementById(`details-${idx}`);
            const icon = document.getElementById(`icon-${idx}`);
            const isShow = row.classList.toggle('show');
            icon.style.transform = isShow ? 'rotate(90deg)' : 'rotate(0deg)';
        }

        // --- Events ---
        document.getElementById('search-btn').addEventListener('click', executeSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeSearch();
        });

        document.getElementById('year-select').addEventListener('change', (e) => {
            yearFilter = e.target.value;
            page = 1;
            render();
        });

        document.getElementById('status-select').addEventListener('change', (e) => {
            statusFilter = e.target.value;
            page = 1;
            render();
        });

        document.getElementById('modalidade-select').addEventListener('change', (e) => {
            modalidadeFilter = e.target.value;
            page = 1;
            render();
        });

        // --- Init ---
        initTheme();
        loadData();
    </script>
</body>
</html>
