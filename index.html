<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNCP Explorer | Dashboard de Contratações</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark .glass-effect { background: rgba(15, 23, 42, 0.8); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; }
        .dark mark { background-color: #854d0e; color: #fef08a; }
        
        /* Modal Animation */
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-hidden .modal-content { transform: scale(0.95); opacity: 0; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-full transition-colors duration-300 overflow-x-hidden">
    
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 w-full border-b border-slate-200 dark:border-slate-800 glass-effect">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="bg-primary-600 p-2 rounded-lg">
                        <i class="fas fa-database text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight">PNCP <span class="text-primary-600">Explorer</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Recent Items Grid (Substituindo Stats) -->
            <div class="mb-4 flex items-center justify-between">
                <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 flex items-center gap-2">
                    <i class="fas fa-clock-rotate-left"></i> Últimas Contratações Buscadas
                </h2>
            </div>
            <div id="recent-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Skeletons -->
                <div class="animate-pulse bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 h-32"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 h-32"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 h-32"></div>
                <div class="animate-pulse bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 h-32"></div>
            </div>

            <!-- Filters & Search -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-4 mb-6 shadow-sm">
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="Buscar por descrição, vencedor, processo..." 
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all">
                        </div>
                        <button id="search-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Ano</label>
                            <select id="year-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todos os Anos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Modalidade</label>
                            <select id="modalidade-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todas as Modalidades</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Status</label>
                            <select id="status-select" class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="all">Todos os Status</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-950 border-b border-slate-200 dark:border-slate-800">
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Publicação</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Ano</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Compra</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Descrição</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Status</th>
                                <th class="px-6 py-4 text-xs font-semibold uppercase tracking-wider text-slate-500">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-primary-600"></div>
                                    <p class="mt-2 text-slate-500">Carregando dados...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="pagination-container" class="px-6 py-4 bg-slate-50 dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <p id="pagination-info" class="text-sm text-slate-500"></p>
                    <div id="pagination-buttons" class="flex items-center gap-1"></div>
                </div>
            </div>
        </main>

        <footer class="py-6 border-t border-slate-200 dark:border-slate-800 text-center text-sm text-slate-500">
            <p>PNCP Explorer &copy; 2026 - Dados atualizados via GitHub Actions</p>
        </footer>
    </div>

    <!-- Modal de Detalhes -->
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden">
        <div class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm modal-backdrop" onclick="closeModal()"></div>
        
        <div class="relative bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col modal-content">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between bg-slate-50 dark:bg-slate-950/50">
                <div class="flex items-center gap-3">
                    <span id="modal-badge" class="px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider"></span>
                    <h3 id="modal-title" class="font-bold text-lg text-primary-600 dark:text-primary-400"></h3>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna Principal -->
                    <div class="lg:col-span-2 space-y-6">
                        <section>
                            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Descrição do Item</h4>
                            <p id="modal-desc" class="text-slate-700 dark:text-slate-300 leading-relaxed text-sm"></p>
                        </section>
                        <section>
                            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Objeto da Compra</h4>
                            <p id="modal-objeto" class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm italic"></p>
                        </section>
                    </div>

                    <!-- Coluna Lateral -->
                    <div class="space-y-4">
                        <div class="bg-slate-50 dark:bg-slate-950/50 p-4 rounded-xl border border-slate-200 dark:border-slate-800">
                            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Resultado</h4>
                            <div class="space-y-3">
                                <div>
                                    <span class="text-[10px] text-slate-500 block">Vencedor</span>
                                    <span id="modal-vencedor" class="text-sm font-bold break-words"></span>
                                </div>
                                <div>
                                    <span class="text-[10px] text-slate-500 block">Valor Homologado</span>
                                    <span id="modal-valor" class="text-lg font-black text-emerald-600"></span>
                                </div>
                                <div>
                                    <span class="text-[10px] text-slate-500 block">Quantidade</span>
                                    <span id="modal-qtd" class="text-sm font-medium"></span>
                                </div>
                            </div>
                        </div>

                        <div class="px-2 space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Processo:</span>
                                <span id="modal-processo" class="font-semibold"></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Modalidade:</span>
                                <span id="modal-modalidade" class="font-semibold"></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Publicação:</span>
                                <span id="modal-data" class="font-semibold"></span>
                            </div>
                        </div>
                        
                        <a id="modal-link" target="_blank" class="flex items-center justify-center gap-2 w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3 rounded-xl font-bold text-sm hover:opacity-90 transition-opacity mt-4">
                            <i class="fas fa-external-link-alt"></i> Ver no PNCP
                        </a>
                    </div>
                </div>
            </div>

            <!-- Modal Footer (Navegação) -->
            <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-800 flex items-center justify-between bg-slate-50 dark:bg-slate-950/50">
                <button id="modal-prev" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-primary-600 transition-colors disabled:opacity-20">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <span id="modal-counter" class="text-xs font-medium text-slate-400"></span>
                <button id="modal-next" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-primary-600 transition-colors disabled:opacity-20">
                    Próximo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const DATA_URL = './dados.json';
        const PER_PAGE = 15;
        
        let allData = [], filteredData = [], search = '', statusFilter = 'all', yearFilter = 'all', modalidadeFilter = 'all', page = 1;
        let currentModalIndex = -1;

        // --- Utils ---
        const normalize = (t) => t ? t.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';
        
        const highlight = (text, term) => {
            if (!term || !text) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.toString().replace(regex, `<mark>$1</mark>`);
        };

        const getBadgeClass = (status) => {
            const map = {
                'Homologado': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400',
                'Fracassado': 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400',
                'Em andamento': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                'Divulgada': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
            };
            return map[status] || 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-400';
        };

        // --- Theme ---
        const initTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });

        // --- Data ---
        async function loadData() {
            try {
                const res = await fetch(`${DATA_URL}?v=${Date.now()}`);
                const json = await res.json();
                allData = json.data || [];
                populateFilters();
                updateFiltered();
                renderRecentCards();
                render();
            } catch (e) {
                console.error(e);
                document.getElementById('table-body').innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-rose-500">Erro ao carregar dados.</td></tr>`;
            }
        }

        function populateFilters() {
            const years = [...new Set(allData.map(i => i.ano))].filter(Boolean).sort((a,b) => b-a);
            const statuses = [...new Set(allData.map(i => i.situacaoItem))].filter(Boolean).sort();
            const modalidades = [...new Set(allData.map(i => i.modalidade))].filter(Boolean).sort();
            
            const ySelect = document.getElementById('year-select');
            years.forEach(y => ySelect.innerHTML += `<option value="${y}">${y}</option>`);
            
            const sSelect = document.getElementById('status-select');
            statuses.forEach(s => sSelect.innerHTML += `<option value="${s}">${s}</option>`);

            const mSelect = document.getElementById('modalidade-select');
            modalidades.forEach(m => mSelect.innerHTML += `<option value="${m}">${m}</option>`);
        }

        // --- Rendering ---
        function renderRecentCards() {
            const container = document.getElementById('recent-items-container');
            // Pegamos os 4 últimos itens do array (que costumam ser os mais recentes na extração incremental)
            const recent = [...allData].slice(-4).reverse();
            
            container.innerHTML = recent.map(item => `
                <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm hover:border-primary-500 transition-colors cursor-pointer group" onclick="openModalByItemData(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold text-primary-600 dark:text-primary-400 uppercase">${item.compra}</span>
                        <span class="text-[10px] text-slate-400">${item.ano}</span>
                    </div>
                    <p class="text-xs font-medium line-clamp-2 mb-3 group-hover:text-primary-600 transition-colors">${item.descricao}</p>
                    <div class="flex items-center justify-between mt-auto">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${getBadgeClass(item.situacaoItem)}">${item.situacaoItem || 'N/A'}</span>
                        <span class="text-[10px] font-black text-emerald-600">R$ ${item.valorTotalHomologado?.toLocaleString('pt-BR', {minimumFractionDigits:2}) || '0,00'}</span>
                    </div>
                </div>
            `).join('');
        }

        function render() {
            const paginated = filteredData.slice((page - 1) * PER_PAGE, page * PER_PAGE);
            renderTable(paginated);
            renderPagination(filteredData.length);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">Nenhum resultado encontrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map((item, idx) => {
                const globalIndex = (page - 1) * PER_PAGE + idx;
                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer group" onclick="openModal(${globalIndex})">
                    <td class="px-6 py-4 text-sm whitespace-nowrap text-slate-500">
                        ${item.dataPublicacao ? new Date(item.dataPublicacao).toLocaleDateString('pt-BR') : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-400">
                        ${item.ano || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm font-bold text-primary-600 dark:text-primary-400">
                        ${highlight(item.compra, search)}
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">
                        ${highlight(item.descricao, search)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${getBadgeClass(item.situacaoItem)}">
                            ${item.situacaoItem || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex items-center gap-3">
                            <button class="text-slate-300 group-hover:text-primary-500 transition-colors">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="${item.linkPNCP}" target="_blank" onclick="event.stopPropagation()" class="text-slate-300 hover:text-primary-600 transition-colors">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function renderPagination(total) {
            const totalPages = Math.ceil(total / PER_PAGE);
            const info = document.getElementById('pagination-info');
            const btns = document.getElementById('pagination-buttons');
            
            info.textContent = `Mostrando ${(page-1)*PER_PAGE+1} a ${Math.min(page*PER_PAGE, total)} de ${total} registros`;
            
            let html = '';
            const addBtn = (p, label, active=false, disabled=false) => {
                html += `<button onclick="goToPage(${p})" ${disabled ? 'disabled' : ''} 
                    class="px-3 py-1.5 rounded-md text-sm font-medium transition-all ${active ? 'bg-primary-600 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 disabled:opacity-30'}">
                    ${label}
                </button>`;
            };

            addBtn(1, '<i class="fas fa-angle-double-left"></i>', false, page === 1);
            addBtn(page - 1, '<i class="fas fa-angle-left"></i>', false, page === 1);
            
            for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                addBtn(i, i, i === page);
            }

            addBtn(page + 1, '<i class="fas fa-angle-right"></i>', false, page === totalPages);
            addBtn(totalPages, '<i class="fas fa-angle-double-right"></i>', false, page === totalPages);
            
            btns.innerHTML = html;
        }

        // --- Modal Logic ---
        function openModal(index) {
            currentModalIndex = index;
            const item = filteredData[index];
            if (!item) return;

            const modal = document.getElementById('details-modal');
            
            // Fill Data
            document.getElementById('modal-title').textContent = item.compra;
            document.getElementById('modal-badge').textContent = item.situacaoItem || 'N/A';
            document.getElementById('modal-badge').className = `px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${getBadgeClass(item.situacaoItem)}`;
            
            document.getElementById('modal-desc').innerHTML = highlight(item.descricao, search);
            document.getElementById('modal-objeto').innerHTML = highlight(item.objeto, search);
            
            document.getElementById('modal-vencedor').innerHTML = highlight(item.vencedor, search) || 'Não informado';
            document.getElementById('modal-valor').textContent = 'R$ ' + (item.valorTotalHomologado?.toLocaleString('pt-BR', {minimumFractionDigits:2}) || '0,00');
            document.getElementById('modal-qtd').textContent = `${item.qtdHomologada || 0} ${item.unidade || ''}`;
            
            document.getElementById('modal-processo').textContent = item.processo || '-';
            document.getElementById('modal-modalidade').textContent = item.modalidade || '-';
            document.getElementById('modal-data').textContent = item.dataPublicacao || '-';
            document.getElementById('modal-link').href = item.linkPNCP;

            // Counter
            document.getElementById('modal-counter').textContent = `${index + 1} de ${filteredData.length}`;

            // Nav Buttons
            document.getElementById('modal-prev').disabled = index === 0;
            document.getElementById('modal-next').disabled = index === filteredData.length - 1;

            // Show
            modal.classList.remove('modal-hidden');
            document.body.style.overflow = 'hidden';
        }

        function openModalByItemData(item) {
            // Encontra o índice desse item na lista filtrada atual para permitir navegação
            const index = filteredData.findIndex(i => i.compra === item.compra && i.itemNo === item.itemNo);
            if (index !== -1) {
                openModal(index);
            } else {
                // Se não estiver na lista filtrada (ex: clicou no card mas tem filtro ativo), abre apenas o item sem navegação
                filteredData.push(item);
                openModal(filteredData.length - 1);
            }
        }

        function closeModal() {
            document.getElementById('details-modal').classList.add('modal-hidden');
            document.body.style.overflow = '';
        }

        function nextItem() {
            if (currentModalIndex < filteredData.length - 1) {
                openModal(currentModalIndex + 1);
            }
        }

        function prevItem() {
            if (currentModalIndex > 0) {
                openModal(currentModalIndex - 1);
            }
        }

        // --- Logic ---
        function updateFiltered() {
            const term = normalize(search);
            filteredData = allData.filter(i => {
                const mSearch = !term || [i.descricao, i.vencedor, i.compra, i.objeto, i.processo].some(v => normalize(v).includes(term));
                const mStatus = statusFilter === 'all' || i.situacaoItem === statusFilter;
                const mYear = yearFilter === 'all' || i.ano == yearFilter;
                const mModalidade = modalidadeFilter === 'all' || i.modalidade === modalidadeFilter;
                return mSearch && mStatus && mYear && mModalidade;
            });
        }

        function executeSearch() {
            search = document.getElementById('search-input').value;
            page = 1;
            updateFiltered();
            render();
        }

        function goToPage(p) {
            page = p;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Events ---
        document.getElementById('search-btn').addEventListener('click', executeSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeSearch();
        });

        document.getElementById('year-select').addEventListener('change', (e) => {
            yearFilter = e.target.value;
            page = 1;
            updateFiltered();
            render();
        });

        document.getElementById('status-select').addEventListener('change', (e) => {
            statusFilter = e.target.value;
            page = 1;
            updateFiltered();
            render();
        });

        document.getElementById('modalidade-select').addEventListener('change', (e) => {
            modalidadeFilter = e.target.value;
            page = 1;
            updateFiltered();
            render();
        });

        document.getElementById('modal-next').addEventListener('click', nextItem);
        document.getElementById('modal-prev').addEventListener('click', prevItem);

        // Teclado
        window.addEventListener('keydown', (e) => {
            const modal = document.getElementById('details-modal');
            if (modal.classList.contains('modal-hidden')) return;

            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowRight') nextItem();
            if (e.key === 'ArrowLeft') prevItem();
        });

        // --- Init ---
        initTheme();
        loadData();
    </script>
</body>
</html>
