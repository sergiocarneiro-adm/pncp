<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor PNCP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc; --card: #fff; --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --success: #16a34a;
            --warning: #d97706; --danger: #dc2626;
            --highlight-bg: #fef9c3; --highlight-text: #713f12;
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #0f172a; --text: #e2e8f0;
            --muted: #94a3b8; --border: #1e293b; --primary: #3b82f6;
            --highlight-bg: #422006; --highlight-text: #fef08a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); transition: background .2s, color .2s; }
        header { background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .container { max-width: 1300px; margin: auto; padding: 2rem; }
        button, input, select { padding: .6rem .75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-family: inherit; font-size: .9rem; transition: all .2s; }
        button { cursor: pointer; }
        button:hover:not(:disabled) { background: #f1f5f9; border-color: var(--primary); }
        [data-theme="dark"] button:hover:not(:disabled) { background: #1e293b; }
        button:disabled { opacity: .5; cursor: not-allowed; }
        button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all .2s; }
        .stat:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat span { font-size: .8rem; color: var(--muted); }
        .stat strong { font-size: 1.3rem; display: block; margin-top: .25rem; }
        .filters { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
        .filters .search-wrapper { display: flex; flex-grow: 1; }
        .filters input { border-top-right-radius: 0; border-bottom-right-radius: 0; min-width: 150px; }
        .filters #search-btn { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; font-size: .85rem; transition: opacity .2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        th { background: #f1f5f9; color: var(--muted); padding: .75rem; text-align: left; font-weight: 600; text-transform: uppercase; font-size: .75rem; }
        [data-theme="dark"] th { background: #1e293b; }
        td { padding: .75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tbody tr:not(.details-row):hover { background: rgba(0, 0, 0, .03); }
        [data-theme="dark"] tbody tr:not(.details-row):hover { background: rgba(255, 255, 255, .03); }
        .badge { padding: .3rem .6rem; border-radius: 999px; font-size: .7rem; font-weight: 600; }
        .success { background: #16a34a20; color: #22c55e; }
        .warning { background: #d9770620; color: #f59e0b; }
        .danger { background: #dc262620; color: #ef4444; }
        .neutral { background: #e5e7eb; color: #374151; }
        [data-theme="dark"] .neutral { background: #374151; color: #d1d5db; }
        a { color: var(--primary); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: .5rem; margin-top: 2rem; flex-wrap: wrap; }
        .pagination-info { text-align: center; margin-bottom: 1rem; font-size: .9rem; color: var(--muted); }
        .loading { padding: 3rem; text-align: center; color: var(--muted); }
        .spinner { width: 36px; height: 36px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .details-row { display: none; }
        .details-row.show { display: table-row; }
        .details-row td { background: #f9fafb; padding: 1rem 1.5rem; }
        [data-theme="dark"] .details-row td { background: #0b1120; }
        .details-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .details-content div { display: flex; flex-direction: column; }
        .details-content span { color: var(--muted); font-size: .75rem; margin-bottom: .25rem; text-transform: uppercase; }
        .details-content strong { font-weight: 500; word-break: break-word; }
        .toggle-details { cursor: pointer; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; background: #f1f5f9; color: var(--muted); font-weight: bold; transition: all .2s; }
        [data-theme="dark"] .toggle-details { background: #1e293b; }
        .toggle-details:hover { background: var(--primary); color: white; }
        mark { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 1px 2px; border-radius: 3px; }
    </style>
</head>
<body>
    <header>
        <strong>Leitor PNCP</strong>
        <button id="theme-toggle">üåô / ‚òÄÔ∏è</button>
    </header>

    <div class="container" id="app">
        <div class="loading"><div class="spinner"></div></div>
    </div>

    <script>
        const DATA_URL = './dados.json';
        const PER_PAGE = 20;

        const app = document.getElementById('app');
        const themeToggle = document.getElementById('theme-toggle');

        let allData = [], stats = {}, search = '', statusFilter = 'all', yearFilter = 'all', page = 1;

        // --- Fun√ß√µes Utilit√°rias ---
        function normalizeText(text) {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function highlightText(text, term) {
            if (!term || !text) return text;
            const normalizedTerm = normalizeText(term);
            const regex = new RegExp(`(${term})`, 'gi');
            return text.toString().replace(regex, `<mark>$1</mark>`);
        }

        // --- Fun√ß√µes de Inicializa√ß√£o ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.dataset.theme = savedTheme;
        }

        async function fetchData() {
            renderLoading();
            try {
                const response = await fetch(`${DATA_URL}?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                allData = result.data || [];
                stats = result.stats || {};
                page = 1;
                render();
            } catch (error) {
                console.error("Erro ao carregar JSON:", error);
                renderError("Erro ao carregar os dados. Verifique o console.");
            }
        }

        // --- Fun√ß√µes de Renderiza√ß√£o ---
        function render() {
            const filteredData = getFilteredData();
            const paginatedData = filteredData.slice((page - 1) * PER_PAGE, page * PER_PAGE);

            app.innerHTML = `
                ${renderStats()}
                ${renderFilters()}
                ${renderPaginationInfo(filteredData.length)}
                ${renderTable(paginatedData)}
                ${renderPagination(filteredData.length)}
            `;
            addEventListeners();
        }

        function renderLoading() { app.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; }
        function renderError(message) { app.innerHTML = `<div class="loading">${message}</div>`; }

        function renderStats() {
            return `
            <div class="stats">
                <div class="stat"><span>Total Itens</span><strong>${stats.totalItens?.toLocaleString('pt-BR') || 0}</strong></div>
                <div class="stat"><span>Valor Estimado</span><strong>R$ ${stats.valorTotalEstimado?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}</strong></div>
                <div class="stat"><span>Homologados</span><strong>${stats.itensHomologados?.toLocaleString('pt-BR') || 0}</strong></div>
                <div class="stat"><span>Fracassados</span><strong>${stats.itensFracassados?.toLocaleString('pt-BR') || 0}</strong></div>
            </div>`;
        }

        function renderFilters() {
            const statusOptions = [...new Set(allData.map(i => i.situacaoItem).filter(Boolean))]
                .map(s => `<option value="${s}" ${statusFilter === s ? 'selected' : ''}>${s}</option>`).join('');
            
            const yearOptions = [...new Set(allData.map(i => i.ano).filter(Boolean))].sort((a, b) => b - a)
                .map(y => `<option value="${y}" ${yearFilter == y ? 'selected' : ''}>${y}</option>`).join('');

            return `
            <div class="filters">
                <div class="search-wrapper">
                    <input id="search-input" placeholder="Buscar..." value="${search}">
                    <button id="search-btn">Buscar</button>
                </div>
                <select id="year-select">
                    <option value="all">Todos os Anos</option>
                    ${yearOptions}
                </select>
                <select id="status-select">
                    <option value="all">Todos os Status</option>
                    ${statusOptions}
                </select>
                <button id="refresh-btn">Atualizar Dados</button>
            </div>`;
        }

        function renderPaginationInfo(totalItems) {
            const totalPages = Math.ceil(totalItems / PER_PAGE);
            const startIdx = (page - 1) * PER_PAGE + 1;
            const endIdx = Math.min(page * PER_PAGE, totalItems);
            return `<div class="pagination-info">Mostrando ${startIdx} a ${endIdx} de ${totalItems} resultados (P√°gina ${page} de ${totalPages})</div>`;
        }

        function renderTable(data) {
            const tableRows = data.length ? data.map((item, index) => `
                <tr data-row-id="${index}">
                    <td><span class="toggle-details" onclick="toggleDetails(${index})">+</span></td>
                    <td>${highlightText(item.dataPublicacao ? new Date(item.dataPublicacao).toLocaleDateString('pt-BR') : '-', search)}</td>
                    <td>${highlightText(item.compra, search) || '-'}</td>
                    <td>${highlightText(item.descricao, search) || '-'}</td>
                    <td>${getBadge(item.situacaoItem)}</td>
                    <td>${item.linkPNCP ? `<a href="${item.linkPNCP}" target="_blank" rel="noopener noreferrer">Abrir</a>` : '-'}</td>
                </tr>
                <tr class="details-row" id="details-${index}">
                    <td colspan="6">
                        <div class="details-content">
                            <div><span>Objeto</span><strong>${highlightText(item.objeto, search) || 'N√£o informado'}</strong></div>
                            <div><span>Vencedor</span><strong>${highlightText(item.vencedor, search) || 'N√£o informado'}</strong></div>
                            <div><span>Item N¬∫</span><strong>${highlightText(item.itemNo, search) || '-'}</strong></div>
                            <div><span>Ano</span><strong>${highlightText(item.ano, search) || '-'}</strong></div>
                        </div>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="6" class="loading">Nenhum item encontrado</td></tr>`;

            return `
            <table>
                <thead><tr>
                    <th></th>
                    <th>Publica√ß√£o</th>
                    <th>Compra</th>
                    <th>Descri√ß√£o</th>
                    <th>Status</th>
                    <th>Link</th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>`;
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / PER_PAGE);
            if (totalPages <= 1) return '';

            let paginationButtons = '';
            const maxButtons = 7;
            let start = Math.max(1, page - Math.floor(maxButtons / 2));
            let end = Math.min(totalPages, start + maxButtons - 1);

            if (end - start + 1 < maxButtons) {
                start = Math.max(1, end - maxButtons + 1);
            }

            // Bot√£o Primeira P√°gina
            paginationButtons += `<button id="first-page" ${page === 1 ? 'disabled' : ''}>¬´ Primeira</button>`;

            // Bot√£o Anterior
            paginationButtons += `<button id="prev-page" ${page === 1 ? 'disabled' : ''}>‚Äπ Anterior</button>`;

            // N√∫meros de p√°gina
            if (start > 1) {
                paginationButtons += `<button onclick="goToPage(1)">1</button>`;
                if (start > 2) paginationButtons += `<span style="padding: 0 .5rem; color: var(--muted);">...</span>`;
            }

            for (let i = start; i <= end; i++) {
                const isActive = i === page;
                paginationButtons += `<button onclick="goToPage(${i})" class="${isActive ? 'active' : ''}">${i}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) paginationButtons += `<span style="padding: 0 .5rem; color: var(--muted);">...</span>`;
                paginationButtons += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // Bot√£o Pr√≥xima
            paginationButtons += `<button id="next-page" ${page >= totalPages ? 'disabled' : ''}>Pr√≥xima ‚Ä∫</button>`;

            // Bot√£o √öltima P√°gina
            paginationButtons += `<button id="last-page" ${page >= totalPages ? 'disabled' : ''}>√öltima ¬ª</button>`;

            return `<div class="pagination">${paginationButtons}</div>`;
        }

        // --- Fun√ß√µes de L√≥gica e Eventos ---
        function addEventListeners() {
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            document.getElementById('search-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
            document.getElementById('status-select').addEventListener('change', handleStatusFilter);
            document.getElementById('year-select').addEventListener('change', handleYearFilter);
            document.getElementById('refresh-btn').addEventListener('click', fetchData);
            document.getElementById('prev-page')?.addEventListener('click', () => { if (page > 1) { page--; render(); } });
            document.getElementById('next-page')?.addEventListener('click', () => { page++; render(); });
            document.getElementById('first-page')?.addEventListener('click', () => { page = 1; render(); });
            document.getElementById('last-page')?.addEventListener('click', () => { 
                const filteredData = getFilteredData();
                page = Math.ceil(filteredData.length / PER_PAGE); 
                render(); 
            });
        }

        function handleSearch() {
            search = document.getElementById('search-input').value;
            page = 1;
            render();
        }

        function handleStatusFilter(event) {
            statusFilter = event.target.value;
            page = 1;
            render();
        }

        function handleYearFilter(event) {
            yearFilter = event.target.value;
            page = 1;
            render();
        }

        function getFilteredData() {
            const normalizedSearchTerm = normalizeText(search);
            if (!normalizedSearchTerm && statusFilter === 'all' && yearFilter === 'all') {
                return allData;
            }

            return allData.filter(item => {
                const matchesSearch = !normalizedSearchTerm || [
                    item.descricao, item.vencedor, item.compra, item.ano, item.objeto, item.itemNo
                ].some(val => normalizeText(val).includes(normalizedSearchTerm));
                
                const matchesStatus = statusFilter === 'all' || item.situacaoItem === statusFilter;
                const matchesYear = yearFilter === 'all' || item.ano == yearFilter;

                return matchesSearch && matchesStatus && matchesYear;
            });
        }

        function getBadge(status) {
            const badges = { 'Homologado': 'success', 'Fracassado': 'danger', 'Em andamento': 'warning' };
            const type = badges[status] || 'neutral';
            return `<span class="badge ${type}">${status || '-'}</span>`;
        }

        function toggleTheme() {
            const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
        }

        function toggleDetails(index) {
            const detailsRow = document.getElementById(`details-${index}`);
            const toggleButton = document.querySelector(`[data-row-id="${index}"] .toggle-details`);
            if (detailsRow) {
                detailsRow.classList.toggle('show');
                toggleButton.textContent = detailsRow.classList.contains('show') ? '‚àí' : '+';
            }
        }

        function goToPage(pageNum) {
            page = pageNum;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        themeToggle.addEventListener('click', toggleTheme);
        initializeTheme();
        fetchData();
    </script>
</body>
</html>
